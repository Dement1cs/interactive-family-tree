{% extends "base.html" %}

{% block title %}Add relation for {{ person["first_name"] }}{% endblock %}

{% block content %}
<h2>Add relation for {{ person["first_name"] }} {{ person["last_name"] or "" }}</h2>

<form action="{{ url_for('add_relation', person_id=person['id']) }}" method="post">
    <div>
        <label for="relation_type">Relation type</label><br>
        <select id="relation_type" name="relation_type" required>
            <option value="">-- choose --</option>
            <option value="parent">Parent</option>
            <option value="child">Child</option>
            <option value="spouse">Spouse</option>
        </select>
    </div>

    <label for="relative_search">Select person</label><br>

    <!-- Поле ввода: пользователь печатает имя человека -->
    <input
        type="text" 
        id="relative_search" 
        placeholder="Type a name..." 
        autocomplete="off"
    >

    <!-- Скрытое поле: сюда мы положим ID выбранного человека.
     Оно отправится на сервер при submit формы -->
    <input type="hidden" name="relative_id" id="relative_id">

    <!-- Контейнер, где будут показываться варианты из поиска.
     Сначала скрыт (display:none) -->
    <div id="search_results" style="border:1px solid #ddd; margin-top:6px; display:none;"></div>
    <!-- Текст “Selected: ...” для пользователя -->
    <p id="selected_person" class="muted"></p>

    <!-- Отправка формы (сохранить связь) -->
    <button type="submit">Save relation</button>
</form>

<p><a href="{{ url_for('person_detail', person_id=person['id']) }}">← Back to profile</a></p>

<script>
    (function () {

    // Находим нужные элементы на странице
    const form = document.querySelector("form"); // сама форма
    const input = document.getElementById("relative_search"); // поле поиска
    const resultsBox = document.getElementById("search_results"); // контейнер результатов
    const hiddenId = document.getElementById("relative_id"); // скрытое поле ID
    const selected = document.getElementById("selected_person"); // текст "Selected: ..."

    // AbortController нужен, чтобы отменять предыдущий запрос поиска,
    // если пользователь быстро печатает и мы запускаем новый запрос.
    let lastController = null;

    // Очистить список результатов и скрыть его
    function clearResults() {
        resultsBox.innerHTML = "";
        resultsBox.style.display = "none";
    }


    // Когда человек выбран из результатов:
    // 1) записываем его id в hidden поле (важно для submit формы)
    // 2) показываем пользователю, кого выбрали
    // 3) вставляем имя в input
    // 4) очищаем результаты
    function setSelected(p) {
        hiddenId.value = p.id;
        selected.textContent = `Selected: ${p.first_name} ${p.last_name || ""}`.trim();
        input.value = `${p.first_name} ${p.last_name || ""}`.trim();
        clearResults();
    }

    // Функция поиска: делает запрос к Flask API и возвращает массив persons
    async function search(q) {
        // если уже был запрос — отменяем его
        if (lastController) lastController.abort();
        lastController = new AbortController();

        // GET /api/persons/search?q=
        const res = await fetch(`/api/persons/search?q=${encodeURIComponent(q)}`, {
        signal: lastController.signal
        });

        // если сервер вернул ошибку — считаем что результатов нет
        if (!res.ok) return [];

        // ожидаем JSON 
        return await res.json();
    }

    // Событие: пользователь что-то печатает в input
    input.addEventListener("input", async () => {
        const q = input.value.trim();

        // Каждый раз при наборе сбрасываем выбранного человека, потому что пользователь меняет запрос
        hiddenId.value = "";
        selected.textContent = "";

        // Если слишком коротко (меньше 2 символов) — не ищем
        if (q.length < 2) {
        clearResults();
        return;
        }

        // Получаем список подходящих людей с сервера
        const persons = await search(q);

        // Готовим resultsBox под новый список
        resultsBox.innerHTML = "";
        resultsBox.style.display = persons.length ? "block" : "none";

        // Для каждого найденного человека создаём кликабельный div
        persons.forEach(p => {
        const item = document.createElement("div");
        item.style.padding = "8px";
        item.style.cursor = "pointer";
        item.textContent = `${p.first_name} ${p.last_name || ""}`.trim();
        item.addEventListener("click", () => setSelected(p));
        resultsBox.appendChild(item);
        });
    });

    // Закрыть список результатов, если кликнули вне него и не на input
    document.addEventListener("click", (e) => {
        if (!resultsBox.contains(e.target) && e.target !== input) {
        clearResults();
        }
    });

    // Перед отправкой формы проверяем: если hiddenId пустой — значит пользователь НЕ выбрал человека из списка
    form.addEventListener("submit", (e) => {
        if (!hiddenId.value) {
        e.preventDefault(); // отменяем отправку формы
        alert("Please select a person from search results.");
        }
    });
    })();
</script>
{% endblock %}
